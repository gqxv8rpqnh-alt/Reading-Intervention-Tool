<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#334155">
    <meta name="description" content="Reading Intervention Management Tool">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Reading Specialist Assistant</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Patrick+Hand&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Crypto JS (For Encryption) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito', 'sans-serif'], hand: ['Patrick Hand', 'cursive'] },
                    colors: {
                        chalkboard: '#334155', paper: '#fafaf9',
                        'apple-red': '#e11d48', 'pencil-yellow': '#f59e0b', 'success-teal': '#0d9488',
                    },
                    boxShadow: { 'card': '0 4px 6px -1px rgba(0,0,0,0.1)', 'floating': '0 10px 15px -3px rgba(0,0,0,0.1)' }
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .note-style { background-color: #fdfbf7; border-left: 4px solid #f59e0b; padding: 1rem 1.25rem; border-radius: 0 0.5rem 0.5rem 0; font-family: 'Patrick Hand', cursive; font-size: 1.15rem; color: #475569; line-height: 1.5; }
        .notebook-texture { background-color: #334155; background-image: radial-gradient(#475569 1.5px, transparent 1.5px); background-size: 24px 24px; }
        .folder-card { background: white; border-radius: 1rem; position: relative; overflow: hidden; border: 1px solid #e2e8f0; transition: transform 0.2s, box-shadow 0.2s; }
        .folder-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; }
        .folder-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 100; display: flex; flexDirection: column; gap: 12px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 14px 20px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); animation: slideIn 0.3s forwards; font-weight: 600; display: flex; align-items: center; border-left: 4px solid #3b82f6; pointer-events: auto; }
        .toast.error { border-left-color: #ef4444; }
        .toast.success { border-left-color: #10b981; }
        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); } }
        .tag-checkbox:checked + div { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
        
        /* Blur effect for locked state */
        .blur-app { filter: blur(5px); pointer-events: none; user-select: none; }
    </style>
</head>
<body class="bg-paper text-slate-800 font-sans h-screen flex overflow-hidden selection:bg-pencil-yellow selection:text-white">

    <!-- SECURITY OVERLAY -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center text-white transition-opacity duration-500">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full border border-slate-700 text-center">
            <div class="bg-apple-red w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg rotate-3">
                <i data-lucide="lock" class="w-8 h-8 text-white"></i>
            </div>
            
            <h1 class="text-3xl font-extrabold mb-2" id="auth-title">ReadingTrack Secure</h1>
            <p class="text-slate-400 mb-8 text-sm" id="auth-subtitle">Student data is encrypted. Enter passcode to unlock.</p>
            
            <form id="auth-form" onsubmit="handleAuth(event)" class="space-y-4">
                <input type="password" id="auth-pass" placeholder="Enter Passcode" class="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-center text-lg tracking-widest focus:ring-2 focus:ring-apple-red outline-none transition-all placeholder:tracking-normal">
                <button type="submit" class="w-full bg-apple-red hover:bg-rose-600 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">
                    Unlock Dashboard
                </button>
            </form>
            <p id="auth-error" class="text-red-400 text-xs mt-4 font-bold hidden flex items-center justify-center"><i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i> Incorrect Passcode</p>
        </div>
        <p class="mt-8 text-slate-500 text-xs max-w-xs text-center">
            <strong>FERPA Compliance Mode:</strong> Data is encrypted locally (AES-256). If you lose your passcode, data cannot be recovered.
        </p>
    </div>

    <!-- MAIN APP WRAPPER -->
    <div id="app-wrapper" class="flex h-full w-full opacity-0 transition-opacity duration-500">
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-20 hidden lg:hidden" onclick="toggleSidebar()"></div>

        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="notebook-texture text-white w-72 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 z-30 flex flex-col h-full shadow-2xl border-r border-slate-700/50">
            <div class="p-6 border-b border-slate-600/50 bg-slate-900/30">
                <div class="flex items-center gap-3">
                    <div class="bg-apple-red p-2.5 rounded-xl text-white shadow-lg transform -rotate-3 ring-2 ring-white/20">
                        <i data-lucide="book-open" class="h-6 w-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-extrabold tracking-wide font-hand pt-1 text-slate-100">Reading<span class="text-pencil-yellow">Track</span></h1>
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-0.5">Specialist Tool</p>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="lg:hidden absolute top-6 right-4 text-slate-400 hover:text-white transition-colors"><i data-lucide="x"></i></button>
            </div>
            <nav class="flex-1 overflow-y-auto py-6 space-y-1.5 px-4">
                <button onclick="nav('dashboard')" class="nav-item w-full flex items-center px-4 py-3.5 text-[15px] font-bold rounded-xl transition-all duration-200 group text-slate-300 hover:bg-white/10 hover:text-white" id="nav-dashboard">
                    <i data-lucide="layout-dashboard" class="mr-3 h-5 w-5 opacity-70 group-hover:opacity-100"></i> <span data-t="dashboard">Dashboard</span>
                </button>
                <button onclick="nav('students')" class="nav-item w-full flex items-center px-4 py-3.5 text-[15px] font-bold rounded-xl transition-all duration-200 group text-slate-300 hover:bg-white/10 hover:text-white" id="nav-students">
                    <i data-lucide="users" class="mr-3 h-5 w-5 opacity-70 group-hover:opacity-100"></i> <span data-t="students">Students</span>
                </button>
                <button onclick="nav('groups')" class="nav-item w-full flex items-center px-4 py-3.5 text-[15px] font-bold rounded-xl transition-all duration-200 group text-slate-300 hover:bg-white/10 hover:text-white" id="nav-groups">
                    <i data-lucide="library" class="mr-3 h-5 w-5 opacity-70 group-hover:opacity-100"></i> <span data-t="groups">Groups</span>
                </button>
                <button onclick="nav('sessions')" class="nav-item w-full flex items-center px-4 py-3.5 text-[15px] font-bold rounded-xl transition-all duration-200 group text-slate-300 hover:bg-white/10 hover:text-white" id="nav-sessions">
                    <i data-lucide="notebook-pen" class="mr-3 h-5 w-5 opacity-70 group-hover:opacity-100"></i> <span data-t="sessions">Session Log</span>
                </button>
                <button onclick="nav('assessments')" class="nav-item w-full flex items-center px-4 py-3.5 text-[15px] font-bold rounded-xl transition-all duration-200 group text-slate-300 hover:bg-white/10 hover:text-white" id="nav-assessments">
                    <i data-lucide="bar-chart-3" class="mr-3 h-5 w-5 opacity-70 group-hover:opacity-100"></i> <span data-t="assessments">Assessments</span>
                </button>
                <button onclick="nav('reports')" class="nav-item w-full flex items-center px-4 py-3.5 text-[15px] font-bold rounded-xl transition-all duration-200 group text-slate-300 hover:bg-white/10 hover:text-white" id="nav-reports">
                    <i data-lucide="sparkles" class="mr-3 h-5 w-5 opacity-70 group-hover:opacity-100"></i> <span data-t="reports">Reports</span>
                </button>
            </nav>
            <div class="p-4 border-t border-slate-600/50 bg-slate-900/30 space-y-3">
                 <button onclick="nav('settings')" class="w-full flex items-center justify-center px-4 py-2.5 text-sm text-slate-400 hover:text-pencil-yellow transition-colors font-bold group">
                    <i data-lucide="settings" class="mr-2 h-4 w-4 group-hover:rotate-45 transition-transform"></i> <span data-t="settings">Data / Settings</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <header class="bg-white shadow-sm z-10 lg:hidden flex items-center justify-between p-4 border-b border-slate-200">
                <div class="flex items-center gap-2"><i data-lucide="book-open" class="h-6 w-6 text-apple-red"></i><h1 class="text-xl font-bold text-slate-800 font-hand">ReadingTrack</h1></div>
                <button onclick="toggleSidebar()" class="text-slate-500 hover:text-slate-800 p-1"><i data-lucide="menu" class="h-7 w-7"></i></button>
            </header>
            <div id="app-content" class="flex-1 overflow-y-auto p-4 md:p-8 lg:p-10 fade-in max-w-7xl mx-auto w-full"></div>
            <div id="toast-container"></div>
        </main>
    </div>

    <!-- Modal -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full relative">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div class="bg-white px-6 pt-8 pb-6" id="modal-content"></div>
            </div>
        </div>
    </div>

<script>
// --- UTILS ---
function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
function openModal(html) { const c=document.getElementById('modal-content'); c.innerHTML=html; document.getElementById('modal-container').classList.remove('hidden'); lucide.createIcons(); }
function showToast(msg, isErr=false) {
    const c=document.getElementById('toast-container'); const t=document.createElement('div');
    t.className = `toast ${isErr ? 'error' : 'success'}`;
    t.innerHTML = isErr ? `<i data-lucide="alert-circle" class="w-5 h-5 mr-3"></i> ${msg}` : `<i data-lucide="check-circle-2" class="w-5 h-5 mr-3"></i> ${msg}`;
    c.appendChild(t); lucide.createIcons();
    setTimeout(() => { t.style.animation='fadeOut 0.4s forwards'; setTimeout(()=>t.remove(),400); }, 3000);
}

// --- SECURE DATA STORE ---
const STORAGE_KEY = 'intervention_app_secure_data';
const defaultState = { students:[], groups:[], sessions:[], assessments:[], settings:{language:'en'} };
let store = null; 
let sessionPasscode = null;

const uid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

// Encryption Helpers
function encryptData(data, key) {
    return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
}

function decryptData(ciphertext, key) {
    const bytes = CryptoJS.AES.decrypt(ciphertext, key);
    return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
}

function saveStore() {
    if(!store || !sessionPasscode) return;
    try {
        const encrypted = encryptData(store, sessionPasscode);
        localStorage.setItem(STORAGE_KEY, encrypted);
    } catch(e) { console.error("Save failed", e); }
}

// --- AUTH LOGIC ---
function initAuth() {
    const encryptedData = localStorage.getItem(STORAGE_KEY);
    const authTitle = document.getElementById('auth-title');
    const authSubtitle = document.getElementById('auth-subtitle');
    const authBtn = document.querySelector('#auth-form button');
    
    lucide.createIcons();

    if(!encryptedData) {
        // First Time Setup
        authTitle.innerText = "Setup Secure Vault";
        authSubtitle.innerText = "Create a passcode to encrypt your student data.";
        authBtn.innerText = "Set Passcode & Enter";
        authBtn.classList.remove('bg-apple-red');
        authBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }
}

function handleAuth(e) {
    e.preventDefault();
    const pass = document.getElementById('auth-pass').value;
    const errorMsg = document.getElementById('auth-error');
    const encryptedData = localStorage.getItem(STORAGE_KEY);

    if(!pass) return;

    if(!encryptedData) {
        // Setup New
        sessionPasscode = pass;
        store = defaultState;
        saveStore();
        unlockApp();
    } else {
        // Login Attempt
        try {
            const data = decryptData(encryptedData, pass);
            if(data && Array.isArray(data.students)) {
                // Success
                sessionPasscode = pass;
                store = data;
                unlockApp();
            } else {
                throw new Error("Invalid decryption");
            }
        } catch(err) {
            errorMsg.classList.remove('hidden');
            document.getElementById('auth-pass').value = '';
            document.getElementById('auth-pass').classList.add('ring-2', 'ring-red-500');
        }
    }
}

function unlockApp() {
    document.getElementById('auth-overlay').style.opacity = '0';
    setTimeout(() => {
        document.getElementById('auth-overlay').classList.add('hidden');
        document.getElementById('app-wrapper').classList.remove('opacity-0');
        nav('dashboard');
    }, 500);
}


function t(k) { const d={dashboard:{en:"Dashboard"},students:{en:"Students"},settings:{en:"Settings"},reports:{en:"Reports"},addStudent:{en:"Add Student"}}; return d[k]?d[k]['en']:k; }

// --- TAXONOMY ---
const skillTaxonomy = {
    "Phonemic Awareness": ["Isolation", "Blending", "Segmentation", "Deletion/Substitution"],
    "Phonics": ["Consonants/Short Vowels", "Digraphs/Blends", "CVCe (Silent E)", "R-Controlled", "Vowel Teams", "Multisyllabic Words"],
    "Fluency": ["Accuracy", "Rate/Pacing", "Prosody/Expression"],
    "Vocabulary": ["Tier 2 Words", "Morphology (Prefix/Suffix)", "Context Clues"],
    "Comprehension": ["Literal", "Inferential", "Main Idea/Summary", "Text Structure"]
};
const observationTags = ["Self-Corrects", "Robot Reading", "Rushing", "Skipping Lines", "Confused b/d", "Guessing", "Strong Decoding", "High Engagement"];

// Global Chart variables
let currentReportChart = null;
let currentStudentChart = null;

// --- NAV ---
let currentView='dashboard';
function nav(v) {
    currentView=v;
    // Destroy charts on navigation to prevent canvas reuse error
    if(currentReportChart){ currentReportChart.destroy(); currentReportChart=null; }
    if(currentStudentChart){ currentStudentChart.destroy(); currentStudentChart=null; }

    document.querySelectorAll('.nav-item').forEach(el=>{ el.classList.remove('bg-pencil-yellow','text-slate-900','shadow-md'); el.classList.add('text-slate-300'); });
    const b=document.getElementById(`nav-${v}`); if(b){ b.classList.remove('text-slate-300'); b.classList.add('bg-pencil-yellow','text-slate-900','shadow-md'); }
    document.getElementById('sidebar').classList.add('-translate-x-full');
    document.getElementById('mobile-overlay').classList.add('hidden');
    const c=document.getElementById('app-content'); c.innerHTML='';
    try {
        if(v==='dashboard') renderDashboard(c);
        else if(v==='students') renderStudents(c);
        else if(v==='groups') renderGroups(c);
        else if(v==='sessions') renderSessions(c);
        else if(v==='assessments') renderAssessments(c);
        else if(v==='reports') renderReports(c);
        else if(v==='settings') renderSettings(c);
    } catch(e) { console.error(e); showToast("Error loading view", true); }
    lucide.createIcons();
}
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('mobile-overlay').classList.toggle('hidden'); }

// --- RENDERERS ---
function renderDashboard(c) {
    const sC = (store.students||[]).length; const gC = (store.groups||[]).length;
    const now=new Date(); const startWeek=new Date(now.setDate(now.getDate()-now.getDay()));
    const wS = (store.sessions||[]).filter(s=>new Date(s.date)>=startWeek).length;

    c.innerHTML = `
    <div class="mb-10 flex justify-between items-end">
        <div><h2 class="text-4xl font-extrabold text-chalkboard-dark mb-1">Dashboard</h2><p class="text-slate-500 text-lg">Welcome back!</p></div>
        <button onclick="openSessionModal()" class="bg-apple-red hover:bg-apple-dark text-white px-6 py-3 rounded-full shadow-lg font-bold flex items-center transition hover:scale-105"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Log Intervention</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="folder-card p-6 flex items-center bg-white shadow-card before:bg-blue-500"><div class="p-4 rounded-2xl bg-blue-50 text-blue-600 mr-5"><i data-lucide="users" class="w-8 h-8"></i></div><div><p class="text-xs text-slate-400 font-bold uppercase">Caseload</p><p class="text-4xl font-extrabold text-slate-800">${sC}</p></div></div>
        <div class="folder-card p-6 flex items-center bg-white shadow-card before:bg-pencil-yellow"><div class="p-4 rounded-2xl bg-amber-50 text-amber-600 mr-5"><i data-lucide="library" class="w-8 h-8"></i></div><div><p class="text-xs text-slate-400 font-bold uppercase">Groups</p><p class="text-4xl font-extrabold text-slate-800">${gC}</p></div></div>
        <div class="folder-card p-6 flex items-center bg-white shadow-card before:bg-apple-red"><div class="p-4 rounded-2xl bg-rose-50 text-rose-600 mr-5"><i data-lucide="clock" class="w-8 h-8"></i></div><div><p class="text-xs text-slate-400 font-bold uppercase">This Week</p><p class="text-4xl font-extrabold text-slate-800">${wS}</p></div></div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-8 rounded-2xl shadow-card border border-slate-100">
            <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center"><i data-lucide="history" class="w-5 h-5 mr-2 text-slate-400"></i> Recent Activity</h3>
            <div class="space-y-4">
                ${(store.sessions||[]).sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5).map(s=>{
                    let t = s.groupId ? ((store.groups||[]).find(g=>g.id===s.groupId)?.groupName||'Group') : ((store.students||[]).find(st=>st.id===s.studentId)?.firstName||'Student');
                    return `<div onclick="editSession('${s.id}')" class="flex items-center p-3 hover:bg-slate-50 rounded-xl cursor-pointer transition-colors"><div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-lg flex flex-col items-center justify-center font-bold text-xs mr-4"><span class="uppercase">${new Date(s.date).toLocaleDateString(undefined,{month:'short'})}</span><span class="text-lg">${new Date(s.date).getDate()}</span></div><div class="flex-1"><p class="font-bold text-slate-800 truncate">${t}</p><p class="text-sm text-slate-500 truncate">${s.focusSkill}</p></div><i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i></div>`;
                }).join('') || '<p class="text-center text-slate-400 py-6">No sessions logged.</p>'}
            </div>
        </div>
        <div class="grid grid-rows-3 gap-4">
             <button onclick="openStudentModal()" class="bg-white p-6 rounded-2xl shadow-sm border hover:border-blue-300 transition-all flex items-center text-left group"><div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-4 group-hover:scale-110 transition-transform"><i data-lucide="user-plus" class="w-6 h-6"></i></div><div><h4 class="font-bold text-slate-800 text-lg">Add New Student</h4><p class="text-slate-500 text-sm">Create profile</p></div></button>
             <button onclick="openGroupModal()" class="bg-white p-6 rounded-2xl shadow-sm border hover:border-amber-300 transition-all flex items-center text-left group"><div class="w-12 h-12 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center mr-4 group-hover:scale-110 transition-transform"><i data-lucide="users" class="w-6 h-6"></i></div><div><h4 class="font-bold text-slate-800 text-lg">Create Group</h4><p class="text-slate-500 text-sm">Organize students</p></div></button>
             <button onclick="nav('reports')" class="bg-white p-6 rounded-2xl shadow-sm border hover:border-purple-300 transition-all flex items-center text-left group"><div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mr-4 group-hover:scale-110 transition-transform"><i data-lucide="file-text" class="w-6 h-6"></i></div><div><h4 class="font-bold text-slate-800 text-lg">Reports</h4><p class="text-slate-500 text-sm">View progress</p></div></button>
        </div>
    </div>`;
}

function renderStudents(c) {
    c.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-3xl font-bold text-slate-800">Students</h2><button onclick="openStudentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow">+ Add</button></div>
    <div class="bg-white rounded-xl shadow overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-4">Name</th><th class="p-4">Grade</th><th class="p-4">Level</th><th class="p-4 text-right">Actions</th></tr></thead><tbody>
    ${(store.students||[]).map(s=>`<tr onclick="openStudentDetail('${s.id}')" class="border-b hover:bg-slate-50 cursor-pointer"><td class="p-4 font-bold text-slate-800">${s.lastName}, ${s.firstName}</td><td class="p-4">Gr ${s.grade}</td><td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded font-bold">${s.currentReadingLevel}</span></td><td class="p-4 text-right"><button onclick="event.stopPropagation(); deleteStudent('${s.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td></tr>`).join('')}
    </tbody></table></div>`;
}

function renderGroups(c) {
    c.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-3xl font-bold text-slate-800">Groups</h2><button onclick="openGroupModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow">+ Add</button></div>
    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">${(store.groups||[]).map(g=>`<div class="bg-white p-6 rounded-xl shadow border hover:border-teal-400 relative group"><button onclick="openGroupModal('${g.id}')" class="absolute top-4 right-4 text-slate-300 hover:text-teal-600"><i data-lucide="pencil" class="w-4 h-4"></i></button><h3 class="font-bold text-xl">${g.groupName}</h3><p class="text-sm text-slate-500 mb-4">${g.schedule}</p><button onclick="openSessionModal(null,'${g.id}')" class="w-full py-2 bg-slate-100 text-slate-700 font-bold rounded hover:bg-slate-200">Log Session</button></div>`).join('')}</div>`;
}

function renderSessions(c) {
    const logs = (store.sessions||[]).sort((a,b)=>new Date(b.date)-new Date(a.date));
    c.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-3xl font-bold text-slate-800">Session Log</h2><button onclick="openSessionModal()" class="bg-pencil-yellow text-slate-900 px-4 py-2 rounded-lg font-bold shadow">+ Log</button></div>
    <div class="space-y-4 max-w-4xl mx-auto">${logs.map(s=>{
        let t = s.groupId ? ((store.groups||[]).find(g=>g.id===s.groupId)?.groupName||'Deleted Group') : ((store.students||[]).find(st=>st.id===s.studentId)?.firstName||'Deleted Student');
        return `<div class="bg-white p-5 rounded-xl shadow border hover:border-slate-300 transition relative group"><div class="flex justify-between mb-2"><div><span class="text-xs font-bold text-slate-400 uppercase">${new Date(s.date).toLocaleDateString()}</span><h4 class="font-bold text-lg">${t}</h4><span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600">${s.focusSkill}</span></div><div class="text-right"><span class="text-xs font-bold text-slate-400">${s.durationMinutes} min</span><div class="mt-1">${s.objectiveMet==='Yes'?'<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>':''}</div></div></div>${s.notes?`<div class="bg-stone-50 p-3 rounded border-l-4 border-amber-400 text-slate-700 italic text-sm">"${s.notes}"</div>`:''}<div class="absolute top-4 right-14 hidden group-hover:flex gap-2"><button onclick="editSession('${s.id}')" class="p-1 text-slate-400 hover:text-blue-500"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteSession('${s.id}')" class="p-1 text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`
    }).join('')}</div>`;
}

function renderAssessments(c) {
    const scores = (store.assessments||[]).sort((a,b)=>new Date(b.date)-new Date(a.date));
    c.innerHTML = `<div class="flex justify-between mb-6"><h2 class="text-3xl font-bold text-slate-800">Assessments</h2><button onclick="openAssessmentModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold shadow">+ Add</button></div>
    <div class="bg-white rounded-xl shadow overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-4">Date</th><th class="p-4">Student</th><th class="p-4">Type</th><th class="p-4">Score</th><th class="p-4 text-right"></th></tr></thead><tbody>
    ${scores.map(a=>{
        let n = (store.students||[]).find(s=>s.id===a.studentId)?.firstName||'?';
        return `<tr class="border-b hover:bg-slate-50"><td class="p-4">${new Date(a.date).toLocaleDateString()}</td><td class="p-4 font-bold">${n}</td><td class="p-4 text-xs">${a.assessmentType}</td><td class="p-4 font-bold text-blue-600">${a.metrics.wcpm||a.metrics.score||'-'}</td><td class="p-4 text-right"><button onclick="deleteAssessment('${a.id}')" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`
    }).join('')}</tbody></table></div>`;
}

function renderReports(c) {
    c.innerHTML = `<h2 class="text-3xl font-bold mb-6">Reports</h2><div class="grid lg:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-xl shadow border-t-4 border-indigo-500 h-fit space-y-4"><label class="block text-xs font-bold text-slate-500 uppercase">Student</label><select id="report-student-id" class="w-full border p-2 rounded"><option value="">Select...</option>${(store.students||[]).map(s=>`<option value="${s.id}">${s.lastName}, ${s.firstName}</option>`).join('')}</select><label class="block text-xs font-bold text-slate-500 uppercase">Start Date</label><input type="date" id="report-start" class="w-full border p-2 rounded"><label class="block text-xs font-bold text-slate-500 uppercase">End Date</label><input type="date" id="report-end" class="w-full border p-2 rounded"><button onclick="generateStudentReport()" class="w-full bg-indigo-600 text-white py-2 rounded font-bold mt-2">Generate</button></div><div class="lg:col-span-2 bg-white p-8 rounded-xl shadow border min-h-[400px]"><div id="report-output-area" class="hidden"><div class="flex justify-between mb-4"><h3 class="font-bold text-xl">Summary</h3><button onclick="copyReport()" class="text-blue-600 font-bold text-sm">Copy</button></div><div id="report-text" class="bg-paper p-6 rounded border mb-6 text-lg leading-relaxed"></div><div class="h-64"><canvas id="report-chart"></canvas></div></div><div id="report-placeholder" class="text-center text-slate-300 mt-20 font-bold text-xl">Select parameters to view report.</div></div></div>`;
    const now=new Date(); const start=new Date(); start.setDate(start.getDate()-90);
    setTimeout(()=>{ if(document.getElementById('report-end')) { document.getElementById('report-end').valueAsDate=now; document.getElementById('report-start').valueAsDate=start; } }, 100);
}

function renderSettings(c) {
    c.innerHTML = `<h2 class="text-3xl font-bold mb-6">Settings</h2><div class="space-y-6">
        <div class="bg-white p-6 rounded-xl shadow border"><h3 class="font-bold text-lg mb-4">Data Management</h3><div class="flex gap-2"><button onclick="exportData()" class="bg-slate-800 text-white px-4 py-2 rounded font-bold">Download JSON</button><button onclick="document.getElementById('import-file').click()" class="border px-4 py-2 rounded font-bold">Upload JSON</button><input id="import-file" type="file" class="hidden" onchange="importData(this)"><button onclick="openJSONPasteModal()" class="border px-4 py-2 rounded font-bold">Paste JSON</button></div></div>
        <div class="bg-white p-6 rounded-xl shadow border"><h3 class="font-bold text-lg mb-4">CSV Tools</h3><div class="flex gap-2"><button onclick="openCSVExport('students')" class="border px-4 py-2 rounded font-bold text-blue-600">Copy Roster CSV</button><button onclick="openCSVImport('students')" class="border px-4 py-2 rounded font-bold text-emerald-600">Import CSV</button></div></div>
        <div class="bg-red-50 p-6 rounded-xl border border-red-200 flex justify-between items-center"><div><h3 class="font-bold text-red-800">Danger Zone</h3><p class="text-red-600 text-sm">Delete all data permanently.</p></div><button onclick="wipeData()" class="bg-white border border-red-200 text-red-600 px-4 py-2 rounded font-bold">Reset App</button></div>
    </div>`;
}

// --- LOGIC FUNCTIONS ---
function openStudentDetail(id) {
    const s=(store.students||[]).find(x=>x.id===id); if(!s) return;
    const sess=(store.sessions||[]).filter(x=>x.studentId===id);
    const tot=sess.reduce((a,c)=>a+parseInt(c.durationMinutes||0),0);
    const content = document.getElementById('app-content');
    content.innerHTML = `<div class="flex justify-between mb-6"><button onclick="nav('students')" class="font-bold text-slate-500">< Back</button><h2 class="text-3xl font-bold">${s.firstName} ${s.lastName}</h2><div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div class="folder-card p-6 shadow border-t-4 border-blue-500"><p class="font-bold text-slate-500 text-xs uppercase">Profile</p><p>Gr ${s.grade} • ${s.primaryLanguage}</p><p class="font-bold">Level ${s.currentReadingLevel}</p></div><div class="folder-card p-6 shadow border-t-4 border-emerald-500"><p class="font-bold text-slate-500 text-xs uppercase">Dosage</p><p class="text-4xl font-bold text-emerald-700">${tot} <span class="text-sm text-emerald-600">min</span></p><p class="text-xs text-slate-400">${sess.length} sessions</p></div><div class="bg-yellow-50 p-6 rounded shadow border relative"><i data-lucide="sticky-note" class="absolute top-4 right-4 text-yellow-300"></i><p class="font-hand text-lg">${s.notes||'No notes.'}</p></div></div><div class="bg-white p-6 rounded-xl shadow border"><h4 class="font-bold mb-4">Progress Monitoring</h4><div class="h-64"><canvas id="student-detail-chart"></canvas></div></div>`;
    lucide.createIcons();
    // Chart
    if(currentStudentChart) { currentStudentChart.destroy(); currentStudentChart=null; }
    
    // Get ALL assessments, sort by date
    const aData = (store.assessments || [])
        .filter(a => a.studentId === id && a.assessmentType.includes('Fluency'))
        .sort((a,b) => new Date(a.date) - new Date(b.date));
    
    // Only WCPM on Chart
    if(aData.length > 0) {
        currentStudentChart = new Chart(document.getElementById('student-detail-chart'), { 
            type:'line', 
            data:{
                labels: aData.map(d => new Date(d.date).toLocaleDateString()), 
                datasets:[{
                    label:'Fluency (WCPM)', 
                    data: aData.map(d => d.metrics.wcpm), 
                    borderColor:'#3b82f6', 
                    tension:0.3,
                    backgroundColor: '#e0e7ff',
                    fill: true
                }]
            }, 
            options:{
                maintainAspectRatio:false,
                scales: { y: { beginAtZero: true } },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const raw = aData[context.dataIndex];
                                return `Accuracy: ${raw.metrics.accuracy || '?'}%`;
                            }
                        }
                    }
                }
            } 
        });
    }
}

function openSessionModal(sId, gId, sessId) {
    let d=new Date().toISOString().slice(0,10), dur=20, n="", tags=[], sk="Phonics: Consonants/Short Vowels", t="Log Intervention", b="Save";
    if(sessId) { const s=(store.sessions||[]).find(x=>x.id===sessId); if(s){ d=s.date; dur=s.durationMinutes; n=s.notes; tags=s.tags||[]; sk=s.focusSkill; t="Edit Session"; b="Update"; if(s.groupId)gId=s.groupId; if(s.studentId)sId=s.studentId; } }
    
    // Skill Options
    let skillOpts = "";
    let skillFound = false;
    for(const [cat, skills] of Object.entries(skillTaxonomy)) {
        skillOpts += `<optgroup label="${cat}">`;
        skills.forEach(s => { 
            const val = `${cat}: ${s}`; 
            if(val===sk) skillFound=true;
            skillOpts+=`<option value="${val}" ${sk===val?'selected':''}>${s}</option>`; 
        });
        skillOpts += `</optgroup>`;
    }
    if(!skillFound && sk) skillOpts += `<option value="${sk}" selected>${sk} (Legacy)</option>`;

    openModal(`
    <h3 class="text-2xl font-bold mb-6">${t}</h3><form onsubmit="saveSession(event)"><input type="hidden" name="id" value="${sessId||''}"><div class="grid grid-cols-2 gap-6 mb-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label><input type="date" name="date" value="${d}" class="w-full border p-2 rounded"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Who?</label><select name="target" class="w-full border p-2 rounded bg-white"><option value="">Select...</option>${(store.groups||[]).map(g=>`<option value="g:${g.id}" ${gId===g.id?'selected':''}>Group: ${g.groupName}</option>`).join('')}${(store.students||[]).map(s=>`<option value="s:${s.id}" ${sId===s.id?'selected':''}>Student: ${s.firstName}</option>`).join('')}</select></div></div><div class="mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Skill</label><select name="focusSkill" class="w-full border p-2 rounded bg-white">${skillOpts}</select></div><div class="mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tags</label><div class="flex flex-wrap gap-2">${observationTags.map(tag=>`<label class="cursor-pointer"><input type="checkbox" name="tags" value="${tag}" class="hidden tag-checkbox" ${tags.includes(tag)?'checked':''}><div class="px-3 py-1 rounded-full border text-xs font-bold ${tags.includes(tag)?'bg-indigo-100 border-indigo-300 text-indigo-700':'bg-white'}">${tag}</div></label>`).join('')}</div></div><div class="mb-6"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Notes</label><textarea name="notes" class="w-full border p-3 rounded note-style text-lg h-24">${n}</textarea></div><button type="submit" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold">${b}</button></form>`);
    
    // Tag Toggle Logic
    document.querySelectorAll('.tag-checkbox').forEach(cb => {
        cb.addEventListener('change', e => { e.target.nextElementSibling.className = e.target.checked ? "px-3 py-1 rounded-full border text-xs font-bold bg-indigo-100 border-indigo-300 text-indigo-700" : "px-3 py-1 rounded-full border text-xs font-bold bg-white"; });
    });
}

function saveSession(e) {
    e.preventDefault(); const d=new FormData(e.target); const t=d.get('target').split(':'); const tags=[...e.target.querySelectorAll('.tag-checkbox:checked')].map(c=>c.value);
    const obj={ id:d.get('id')||uid(), date:d.get('date'), groupId:t[0]==='g'?t[1]:null, studentId:t[0]!=='g'?t[1]:null, focusSkill:d.get('focusSkill'), durationMinutes:20, objectiveMet:'Yes', engagement:'High', notes:d.get('notes'), tags:tags };
    if(obj.id && (store.sessions||[]).find(x=>x.id===obj.id)) { const i=store.sessions.findIndex(x=>x.id===obj.id); store.sessions[i]=obj; } else { (store.sessions=store.sessions||[]).push(obj); }
    saveStore(); closeModal(); nav('sessions'); showToast("Saved");
}

function editSession(id) { openSessionModal(null, null, id); }
function deleteSession(id) { store.sessions=store.sessions.filter(s=>s.id!==id); saveStore(); nav('sessions'); showToast("Deleted"); }
function deleteStudent(id) { store.students=store.students.filter(s=>s.id!==id); saveStore(); nav('students'); showToast("Deleted"); }
function deleteAssessment(id) { store.assessments=store.assessments.filter(a=>a.id!==id); saveStore(); nav('assessments'); showToast("Deleted"); }

// --- REPORT GEN ---
function generateStudentReport() {
    const sId=document.getElementById('report-student-id').value; if(!sId)return;
    const s=store.students.find(x=>x.id===sId);
    const start=new Date(document.getElementById('report-start').value); const end=new Date(document.getElementById('report-end').value);
    const logs=(store.sessions||[]).filter(x=>(x.studentId===sId||(store.groups||[]).find(g=>g.id===x.groupId && g.studentIds.includes(sId))) && new Date(x.date)>=start && new Date(x.date)<=end);
    
    // Sort assessments by date
    const relAssessments = (store.assessments || []).filter(a => a.studentId === sId && new Date(a.date) >= start && new Date(a.date) <= end).sort((a,b) => new Date(a.date) - new Date(b.date));
    const fluencyAssessments = relAssessments.filter(a => a.assessmentType.includes("Fluency"));

    // Calculate metrics
    const totalMin = logs.reduce((acc, curr) => acc + parseInt(curr.durationMinutes||0), 0);
    const skillCount = {}; logs.forEach(l => { const sk = l.focusSkill.split(':')[0]; skillCount[sk] = (skillCount[sk]||0)+1; });
    const topSkills = Object.entries(skillCount).sort((a,b)=>b[1]-a[1]).slice(0,2).map(x=>x[0]).join(" and ");

    let txt=`<strong>${s.firstName} ${s.lastName} Progress Report</strong><br>
    <span class="text-sm text-slate-500">${start.toLocaleDateString()} - ${end.toLocaleDateString()}</span><br><br>
    <strong>Instruction:</strong> ${s.firstName} received <strong>${totalMin} minutes</strong> of intervention across <strong>${logs.length} sessions</strong>. 
    Focus areas included <strong>${topSkills || 'various skills'}</strong>.<br><br>
    <strong>Observations:</strong><br>
    ${logs.slice(0,5).map(l=>`• ${new Date(l.date).toLocaleDateString()}: ${l.notes}`).join('<br>')}`;
    
    if(relAssessments.length > 0) {
        txt += `<br><br><strong>Assessment Data:</strong><br>`;
        if (fluencyAssessments.length > 0) {
            const first = fluencyAssessments[0].metrics.wcpm;
            const last = fluencyAssessments[fluencyAssessments.length-1].metrics.wcpm;
            txt += `• <strong>Fluency Growth:</strong> ${s.firstName} moved from <strong>${first} WCPM</strong> to <strong>${last} WCPM</strong>.<br>`;
        }
        // Mention other assessments loosely
        const otherCount = relAssessments.length - fluencyAssessments.length;
        if(otherCount > 0) {
            txt += `• Additional assessments indicate performance in accuracy and raw scores (see chart tooltips for details).`;
        }
    } else {
        txt += `<br><br><em>No assessments recorded in this period.</em>`;
    }

    document.getElementById('report-output-area').classList.remove('hidden'); document.getElementById('report-placeholder').classList.add('hidden');
    document.getElementById('report-text').innerHTML=txt;
    
    // Chart (WCPM ONLY)
    if(currentReportChart) { currentReportChart.destroy(); currentReportChart=null; }
    
    // Only chart fluency to keep it clean
    if(fluencyAssessments.length>0) {
        currentReportChart = new Chart(document.getElementById('report-chart'), { 
            type:'line', 
            data:{
                labels: fluencyAssessments.map(d=>new Date(d.date).toLocaleDateString()), 
                datasets:[{
                    label:'Fluency (WCPM)', 
                    data: fluencyAssessments.map(d=>d.metrics.wcpm), 
                    borderColor:'#3b82f6', 
                    tension:0.3,
                    backgroundColor: '#e0e7ff',
                    fill: true
                }]
            }, 
            options:{
                maintainAspectRatio:false,
                scales: { y: { beginAtZero: true } },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const raw = fluencyAssessments[context.dataIndex];
                                return `Accuracy: ${raw.metrics.accuracy || '?'}%`;
                            }
                        }
                    }
                }
            } 
        });
    }
}
function copyReport() { navigator.clipboard.writeText(document.getElementById('report-text').innerText); showToast("Copied"); }

// --- IMPORT/EXPORT/CSV ---
function parseJSONInput(raw) {
    let str=raw.replace(/```json/g,'').replace(/```/g,'');
    const s=str.indexOf('{'), e=str.lastIndexOf('}');
    if(s!==-1 && e!==-1) str=str.substring(s,e+1);
    // Sanitize quotes and spacing
    str = str.replace(/[\u2018\u2019]/g, "'").replace(/[\u201C\u201D]/g, '"').replace(/\u00A0/g, ' ').replace(/\t/g, ' ');
    return { ...defaultState, ...JSON.parse(str) };
}
function openJSONPasteModal() { openModal(`<h3 class="text-xl font-bold mb-4">Paste JSON</h3><textarea id="json-paste-area" class="w-full h-64 border p-2 font-mono text-xs"></textarea><button onclick="processJSONPaste()" class="w-full bg-slate-800 text-white py-2 mt-4 font-bold rounded">Import</button>`); }
function processJSONPaste() { try { store=parseJSONInput(document.getElementById('json-paste-area').value); saveStore(); closeModal(); showToast("Imported"); nav('dashboard'); } catch(e){ alert("Invalid JSON: " + e.message); } }
function wipeData() { store={students:[],groups:[],sessions:[],assessments:[],settings:{language:'en'}}; saveStore(); nav('dashboard'); showToast("Reset"); }
function openCSVImport(t) { openModal(`<h3 class="text-xl font-bold mb-4">Import CSV</h3><textarea id="csv-area" class="w-full h-64 border p-2"></textarea><button onclick="processCSV()" class="w-full bg-blue-600 text-white py-2 mt-4 rounded font-bold">Import</button>`); }
function processCSV() {
    const rows=document.getElementById('csv-area').value.split('\n'); let c=0;
    rows.forEach((r,i)=>{ if(i===0)return; const cols=r.split(','); if(cols.length>1){ store.students.push({id:uid(), firstName:cols[0], lastName:cols[1], grade:cols[2], primaryLanguage:cols[3], ellStatus:'No', currentReadingLevel:'', notes:''}); c++; } });
    saveStore(); closeModal(); showToast(`Imported ${c}`); nav('students');
}
function openCSVExport(t) {
    let csv="firstName,lastName,grade,lang,level\n";
    if(t==='students') csv+=store.students.map(s=>`${s.firstName},${s.lastName},${s.grade},${s.primaryLanguage},${s.currentReadingLevel}`).join('\n');
    else if(t==='sessions') csv="date,skill,duration,notes\n"+store.sessions.map(s=>`${s.date},"${s.focusSkill}",${s.durationMinutes},"${s.notes}"`).join('\n');
    openModal(`<h3 class="text-xl font-bold mb-4">Export CSV</h3><textarea class="w-full h-64 border p-2">${csv}</textarea><p class="text-sm text-slate-500 mt-2">Copy and paste into Excel.</p>`);
}

// Add these missing openModal forms
function openStudentModal() {
    openModal(`
    <h3 class="text-2xl font-bold mb-6">Add Student</h3><form onsubmit="saveStudent(event)"><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-xs font-bold uppercase mb-1 text-slate-500">First Name</label><input name="firstName" required class="w-full border p-2 rounded"></div><div><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Last Name</label><input name="lastName" required class="w-full border p-2 rounded"></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Grade</label><select name="grade" class="w-full border p-2 rounded bg-white"><option>K</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div><div><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Language</label><select name="primaryLanguage" class="w-full border p-2 rounded bg-white"><option>English</option><option>Spanish</option><option>Bilingual</option></select></div></div><div class="mb-4"><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Reading Level</label><input name="currentReadingLevel" class="w-full border p-2 rounded"></div><div class="mb-6"><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Notes</label><textarea name="notes" class="w-full border p-2 rounded h-20"></textarea></div><button type="submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold">Save Student</button></form>`);
}

function saveStudent(e) {
    e.preventDefault(); const d=new FormData(e.target);
    store.students.push({id:uid(), firstName:d.get('firstName'), lastName:d.get('lastName'), grade:d.get('grade'), primaryLanguage:d.get('primaryLanguage'), currentReadingLevel:d.get('currentReadingLevel'), notes:d.get('notes'), ellStatus:'No'});
    saveStore(); closeModal(); nav('students'); showToast("Student Added");
}

function openGroupModal(gid) {
    let n="", gr="K", s=[], t="Create Group", b="Save";
    if(gid){ const g=store.groups.find(x=>x.id===gid); if(g){ n=g.groupName; gr=g.grade; s=g.studentIds; t="Edit Group"; b="Update"; } }
    openModal(`
    <h3 class="text-2xl font-bold mb-6">${t}</h3><form onsubmit="saveGroup(event)"><input type="hidden" name="id" value="${gid||''}"> <div class="mb-4"><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Group Name</label><input name="groupName" value="${n}" required class="w-full border p-2 rounded"></div><div class="mb-4"><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Grade</label><select name="grade" class="w-full border p-2 rounded bg-white"><option ${gr==='K'?'selected':''}>K</option><option ${gr==='1'?'selected':''}>1</option><option ${gr==='2'?'selected':''}>2</option><option ${gr==='3'?'selected':''}>3</option><option ${gr==='4'?'selected':''}>4</option><option ${gr==='5'?'selected':''}>5</option></select></div><div class="mb-6"><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Students</label><div class="border p-2 rounded max-h-48 overflow-y-auto">${store.students.map(st=>`<label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded"><input type="checkbox" name="sids" value="${st.id}" ${s.includes(st.id)?'checked':''}> ${st.firstName} ${st.lastName}</label>`).join('')}</div></div><button type="submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold">${b}</button></form>`);
}

function saveGroup(e) {
    e.preventDefault(); const d=new FormData(e.target); const sids=[...e.target.querySelectorAll('input[name="sids"]:checked')].map(c=>c.value);
    const obj={id:d.get('id')||uid(), groupName:d.get('groupName'), grade:d.get('grade'), schedule:'', studentIds:sids};
    if(obj.id && store.groups.find(g=>g.id===obj.id)){ const i=store.groups.findIndex(g=>g.id===obj.id); store.groups[i]=obj; } else { store.groups.push(obj); }
    saveStore(); closeModal(); nav('groups'); showToast("Group Saved");
}

function openAssessmentModal(sid, aid) {
    let d=new Date().toISOString().slice(0,10), type="Fluency (ORF)", sc="", n="", t="Add Score", b="Save";
    if(aid){ const a=store.assessments.find(x=>x.id===aid); if(a){ d=a.date; type=a.assessmentType; sc=a.metrics.wcpm||a.metrics.score; n=a.notes; t="Edit Score"; b="Update"; sid=a.studentId; } }
    openModal(`
    <h3 class="text-2xl font-bold mb-6">${t}</h3><form onsubmit="saveAssessment(event)"><input type="hidden" name="id" value="${aid||''}"><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Date</label><input type="date" name="date" value="${d}" required class="w-full border p-2 rounded"></div><div><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Student</label><select name="studentId" class="w-full border p-2 rounded bg-white">${store.students.map(s=>`<option value="${s.id}" ${sid===s.id?'selected':''}>${s.firstName} ${s.lastName}</option>`).join('')}</select></div></div><div class="mb-4"><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Type</label><select name="type" class="w-full border p-2 rounded bg-white"><option ${type==='Fluency (ORF)'?'selected':''}>Fluency (ORF)</option><option ${type==='Decoding'?'selected':''}>Decoding</option><option ${type==='Comprehension'?'selected':''}>Comprehension</option></select></div><div class="mb-4"><label class="block text-xs font-bold uppercase mb-1 text-slate-500">Score (WCPM/Points)</label><input type="number" name="score" value="${sc}" class="w-full border p-2 rounded"></div><button type="submit" class="w-full bg-purple-600 text-white py-3 rounded font-bold">${b}</button></form>`);
}

function saveAssessment(e) {
    e.preventDefault(); const d=new FormData(e.target);
    const obj={id:d.get('id')||uid(), date:d.get('date'), studentId:d.get('studentId'), assessmentType:d.get('type'), metrics:{wcpm:d.get('score'), score:d.get('score')}, notes:''};
    if(obj.id && store.assessments.find(a=>a.id===obj.id)){ const i=store.assessments.findIndex(a=>a.id===obj.id); store.assessments[i]=obj; } else { store.assessments.push(obj); }
    saveStore(); closeModal(); nav('assessments'); showToast("Score Saved");
}

window.addEventListener('DOMContentLoaded', () => { initAuth(); });
</script>
</body>
</html>